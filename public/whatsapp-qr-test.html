<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ú©Ø§Ù…Ù„ WhatsApp QR Code</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .auth-section {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .campaign-section {
            background: #f3e5f5;
            border: 1px solid #ce93d8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .qr-section {
            background: #e8f5e8;
            border: 1px solid #a5d6a7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .qr-code-display {
            margin: 20px 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .form-group {
            margin: 10px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ØªØ³Øª Ú©Ø§Ù…Ù„ WhatsApp QR Code</h1>
        
        <!-- Authentication Section -->
        <div class="auth-section">
            <h3>ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</h3>
            <div class="form-group">
                <label for="email">Ø§ÛŒÙ…ÛŒÙ„:</label>
                <input type="email" id="email" placeholder="user@example.com" value="ali@example.com">
            </div>
            <div class="form-group">
                <label for="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" value="password123">
            </div>
            <button id="login-btn" class="btn">ÙˆØ±ÙˆØ¯</button>
            <button id="logout-btn" class="btn" style="display: none;">Ø®Ø±ÙˆØ¬</button>
            <div id="auth-status" class="status"></div>
        </div>
        
        <!-- Campaign Section -->
        <div class="campaign-section">
            <h3>ğŸ“‹ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù…Ù¾ÛŒÙ†</h3>
            <div class="form-group">
                <label for="campaign-title">Ø¹Ù†ÙˆØ§Ù† Ú©Ù…Ù¾ÛŒÙ†:</label>
                <input type="text" id="campaign-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©Ù…Ù¾ÛŒÙ†" value="ØªØ³Øª QR Code">
            </div>
            <div class="form-group">
                <label for="campaign-message">Ù¾ÛŒØ§Ù…:</label>
                <input type="text" id="campaign-message" placeholder="Ù¾ÛŒØ§Ù… Ú©Ù…Ù¾ÛŒÙ†" value="Ø³Ù„Ø§Ù…ØŒ Ø§ÛŒÙ† ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ³Øª Ø§Ø³Øª">
            </div>
            <button id="create-campaign-btn" class="btn" disabled>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†</button>
            <button id="generate-qr-btn" class="btn" disabled>ØªÙˆÙ„ÛŒØ¯ QR Code</button>
            <div id="campaign-status" class="status"></div>
        </div>
        
        <!-- QR Code Section -->
        <div class="qr-section">
            <h3>ğŸ“± QR Code WhatsApp</h3>
            <div id="qr-container" class="qr-code-display">
                <p>QR Code Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
            </div>
            <div id="qr-instructions" class="hidden">
                <h4>ğŸ“± Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„:</h4>
                <ol>
                    <li>WhatsApp Ø±Ø§ Ø¯Ø± Ú¯ÙˆØ´ÛŒ Ø®ÙˆØ¯ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯</li>
                    <li>Ø¨Ù‡ Settings > Linked Devices Ø¨Ø±ÙˆÛŒØ¯</li>
                    <li>Link a Device Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</li>
                    <li>QR Code Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯</li>
                </ol>
            </div>
            <div id="qr-status" class="status"></div>
        </div>
        
        <!-- Connection Status -->
        <div id="connection-section" class="hidden">
            <h3>ğŸ”— ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</h3>
            <div id="connection-status" class="status"></div>
            <button id="check-connection-btn" class="btn">Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„</button>
        </div>
        
        <!-- Log Section -->
        <div>
            <h3>ğŸ“ Ù„Ø§Ú¯â€ŒÙ‡Ø§</h3>
            <div id="log-container" class="log"></div>
            <button id="clear-log-btn" class="btn">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„Ø§Ú¯</button>
        </div>
    </div>

    <script>
        class WhatsAppQRTest {
            constructor() {
                this.token = null;
                this.userId = null;
                this.campaignId = null;
                this.socket = null;
                this.isConnected = false;
                
                this.initializeElements();
                this.attachEventListeners();
            }
            
            initializeElements() {
                this.elements = {
                    email: document.getElementById('email'),
                    password: document.getElementById('password'),
                    loginBtn: document.getElementById('login-btn'),
                    logoutBtn: document.getElementById('logout-btn'),
                    authStatus: document.getElementById('auth-status'),
                    
                    campaignTitle: document.getElementById('campaign-title'),
                    campaignMessage: document.getElementById('campaign-message'),
                    createCampaignBtn: document.getElementById('create-campaign-btn'),
                    generateQrBtn: document.getElementById('generate-qr-btn'),
                    campaignStatus: document.getElementById('campaign-status'),
                    
                    qrContainer: document.getElementById('qr-container'),
                    qrInstructions: document.getElementById('qr-instructions'),
                    qrStatus: document.getElementById('qr-status'),
                    
                    connectionSection: document.getElementById('connection-section'),
                    connectionStatus: document.getElementById('connection-status'),
                    checkConnectionBtn: document.getElementById('check-connection-btn'),
                    
                    logContainer: document.getElementById('log-container'),
                    clearLogBtn: document.getElementById('clear-log-btn')
                };
            }
            
            attachEventListeners() {
                this.elements.loginBtn.onclick = () => this.login();
                this.elements.logoutBtn.onclick = () => this.logout();
                this.elements.createCampaignBtn.onclick = () => this.createCampaign();
                this.elements.generateQrBtn.onclick = () => this.generateQRCode();
                this.elements.checkConnectionBtn.onclick = () => this.checkConnection();
                this.elements.clearLogBtn.onclick = () => this.clearLog();
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
                this.elements.logContainer.appendChild(logEntry);
                this.elements.logContainer.scrollTop = this.elements.logContainer.scrollHeight;
            }
            
            clearLog() {
                this.elements.logContainer.innerHTML = '';
            }
            
            showStatus(element, message, type = 'info') {
                element.textContent = message;
                element.className = `status ${type}`;
            }
            
            async login() {
                try {
                    this.log('ğŸ” Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯...');
                    this.showStatus(this.elements.authStatus, 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...', 'waiting');
                    
                    const response = await fetch('/api/user/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: this.elements.email.value,
                            password: this.elements.password.value
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.token = data.token;
                    this.userId = data.user.id;
                    
                    this.log(`âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ - User ID: ${this.userId}`);
                    this.showStatus(this.elements.authStatus, 'ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚', 'success');
                    
                    this.elements.loginBtn.style.display = 'none';
                    this.elements.logoutBtn.style.display = 'inline-block';
                    this.elements.createCampaignBtn.disabled = false;
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`);
                    this.showStatus(this.elements.authStatus, `Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error');
                }
            }
            
            logout() {
                this.token = null;
                this.userId = null;
                this.campaignId = null;
                
                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }
                
                this.log('ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…');
                this.showStatus(this.elements.authStatus, 'Ø®Ø±ÙˆØ¬ Ø§Ø² Ø³ÛŒØ³ØªÙ…', 'info');
                
                this.elements.loginBtn.style.display = 'inline-block';
                this.elements.logoutBtn.style.display = 'none';
                this.elements.createCampaignBtn.disabled = true;
                this.elements.generateQrBtn.disabled = true;
                this.elements.connectionSection.classList.add('hidden');
            }
            
            async createCampaign() {
                try {
                    this.log('ğŸ“‹ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ† Ø¬Ø¯ÛŒØ¯...');
                    this.showStatus(this.elements.campaignStatus, 'Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†...', 'waiting');
                    
                    const response = await fetch('/api/campaigns', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify({
                            title: this.elements.campaignTitle.value,
                            message: this.elements.campaignMessage.value,
                            recipients: [
                                { phone: '989123456789', name: 'ØªØ³Øª' }
                            ]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.campaignId = data.campaign.id;
                    
                    this.log(`âœ… Ú©Ù…Ù¾ÛŒÙ† Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ - ID: ${this.campaignId}`);
                    this.showStatus(this.elements.campaignStatus, 'Ú©Ù…Ù¾ÛŒÙ† Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                    
                    this.elements.generateQrBtn.disabled = false;
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†: ${error.message}`);
                    this.showStatus(this.elements.campaignStatus, `Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ†: ${error.message}`, 'error');
                }
            }
            
            async generateQRCode() {
                try {
                    this.log('ğŸ“± ØªÙˆÙ„ÛŒØ¯ QR Code...');
                    this.showStatus(this.elements.qrStatus, 'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ QR Code...', 'waiting');
                    
                    // Connect to WebSocket first
                    this.connectWebSocket();
                    
                    // Generate QR Code
                    const response = await fetch(`/api/campaigns/${this.campaignId}/qr-code`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.log(`âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª QR Code Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${data.message}`);
                    this.showStatus(this.elements.qrStatus, 'QR Code Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯...', 'info');
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ QR Code: ${error.message}`);
                    this.showStatus(this.elements.qrStatus, `Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ QR Code: ${error.message}`, 'error');
                }
            }
            
            connectWebSocket() {
                if (this.socket) {
                    this.socket.close();
                }
                
                const wsUrl = `ws://localhost:3000/ws/campaigns?campaignId=${this.campaignId}&userId=${this.userId}`;
                this.log(`ğŸ”Œ Ø§ØªØµØ§Ù„ Ø¨Ù‡ WebSocket: ${wsUrl}`);
                
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onopen = () => {
                    this.log('âœ… WebSocket Ù…ØªØµÙ„ Ø´Ø¯');
                    this.isConnected = true;
                };
                
                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.log(`ğŸ“¨ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… WebSocket: ${data.type}`);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… WebSocket: ${error.message}`);
                    }
                };
                
                this.socket.onclose = () => {
                    this.log('âŒ WebSocket Ù‚Ø·Ø¹ Ø´Ø¯');
                    this.isConnected = false;
                };
                
                this.socket.onerror = (error) => {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± WebSocket: ${error.message}`);
                };
            }
            
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'qr_code':
                        this.log('ğŸ“± QR Code Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');
                        this.displayQRCode(data.data);
                        break;
                    case 'status_update':
                        this.log(`ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ${data.data.status} - ${data.data.message}`);
                        this.showStatus(this.elements.qrStatus, data.data.message, 'info');
                        break;
                    case 'error_update':
                        this.log(`âŒ Ø®Ø·Ø§: ${data.data.error}`);
                        this.showStatus(this.elements.qrStatus, data.data.error, 'error');
                        break;
                    default:
                        this.log(`ğŸ“¨ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡: ${data.type}`);
                }
            }
            
            displayQRCode(qrData) {
                this.elements.qrContainer.innerHTML = '';
                
                // Handle different QR code formats
                let qrText = '';
                if (typeof qrData === 'string') {
                    qrText = qrData;
                } else if (qrData.qrCode) {
                    qrText = qrData.qrCode;
                } else if (qrData.raw) {
                    qrText = qrData.raw;
                }
                
                this.log(`ğŸ“± QR Code: ${qrText.substring(0, 50)}...`);
                
                if (typeof QRCode !== 'undefined') {
                    new QRCode(this.elements.qrContainer, {
                        text: qrText,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    this.elements.qrContainer.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h4>QR Code:</h4>
                            <pre style="word-break: break-all; font-size: 12px;">${qrText}</pre>
                        </div>
                    `;
                }
                
                this.elements.qrInstructions.classList.remove('hidden');
                this.elements.connectionSection.classList.remove('hidden');
                this.showStatus(this.elements.qrStatus, 'QR Code Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', 'success');
            }
            
            async checkConnection() {
                try {
                    this.log('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„...');
                    
                    const response = await fetch(`/api/campaigns/${this.campaignId}/connection`, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    this.log(`ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„: ${JSON.stringify(data)}`);
                    
                    if (data.isConnected) {
                        this.showStatus(this.elements.connectionStatus, 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª', 'success');
                    } else {
                        this.showStatus(this.elements.connectionStatus, 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª', 'error');
                    }
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„: ${error.message}`);
                    this.showStatus(this.elements.connectionStatus, `Ø®Ø·Ø§: ${error.message}`, 'error');
                }
            }
        }
        
        // Initialize the test
        const whatsappTest = new WhatsAppQRTest();
        
        // Log initial state
        whatsappTest.log('ğŸš€ ØªØ³Øª WhatsApp QR Code Ø´Ø±ÙˆØ¹ Ø´Ø¯');
        whatsappTest.log('ğŸ“‹ Ù…Ø±Ø§Ø­Ù„: 1) ÙˆØ±ÙˆØ¯ 2) Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù…Ù¾ÛŒÙ† 3) ØªÙˆÙ„ÛŒØ¯ QR Code 4) Ø§Ø³Ú©Ù† Ø¨Ø§ Ú¯ÙˆØ´ÛŒ');
    </script>
</body>
</html>
